# Unicode åŸºç¤æ¦‚å¿µæ•´ç†

## å…¨ä½“åƒ

```
Unicode Text
  â”‚
  â”œâ”€â”€ Byte (ãƒã‚¤ãƒˆ)        â† ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¾å­˜ã®æœ€å°å˜ä½
  â”œâ”€â”€ Code Unit (ç¬¦å·å˜ä½)  â† ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®å‡¦ç†å˜ä½
  â”œâ”€â”€ Code Point (ç¬¦å·ä½ç½®) â† æ–‡å­—ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸç•ªå·
  â”œâ”€â”€ Scalar Value         â† ã‚µãƒ­ã‚²ãƒ¼ãƒˆã‚’é™¤ã„ãŸ Code Point
  â””â”€â”€ Grapheme Cluster     â† äººé–“ãŒã€Œ1æ–‡å­—ã€ã¨èªè­˜ã™ã‚‹å˜ä½
```

ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œæ•°ãˆã‚‹ã€ã¨ãã€ä½•ã‚’å˜ä½ã«ã™ã‚‹ã‹ã§çµæœãŒå¤‰ã‚ã‚‹ã€‚

---

## Code Point (ç¬¦å·ä½ç½®)

Unicode ãŒå®šç¾©ã™ã‚‹**æ–‡å­—ã®ç•ªå·**ã€‚U+0000 ~ U+10FFFF ã®ç¯„å›² (ç´„111ä¸‡å€‹)ã€‚

```
U+0041  â†’ A
U+3042  â†’ ã‚
U+1F600 â†’ ğŸ˜€
```

1ã¤ã® Code Point ãŒå¿…ãšã—ã‚‚1ã¤ã®ã€Œè¦‹ãˆã‚‹æ–‡å­—ã€ã«å¯¾å¿œã™ã‚‹ã‚ã‘ã§ã¯ãªã„ã€‚
çµåˆæ–‡å­—(Combining Character) ã‚„åˆ¶å¾¡æ–‡å­—ã®ã‚ˆã†ã«ã€å˜ç‹¬ã§ã¯è¡¨ç¤ºã•ã‚Œãªã„ Code Point ã‚‚ã‚ã‚‹ã€‚

### Scalar Value

Code Point ã®ã†ã¡ **ã‚µãƒ­ã‚²ãƒ¼ãƒˆ (U+D800 ~ U+DFFF)** ã‚’é™¤ã„ãŸã‚‚ã®ã€‚
ã‚µãƒ­ã‚²ãƒ¼ãƒˆã¯ UTF-16 ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã«ä½¿ã‚ã‚Œã‚‹ãƒšã‚¢ã§ã€æ–‡å­—ãã®ã‚‚ã®ã§ã¯ãªã„ã€‚
Rust ã® `char` å‹ã¯ Scalar Value ã‚’è¡¨ã™ã€‚

---

## ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ Code Unit

### ãã‚‚ãã‚‚ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ã¯

Code Point ã¯ãŸã ã®**ç•ªå·** (ä¾‹: U+3042 = 12354)ã€‚
ã“ã‚Œã‚’ãƒ¡ãƒ¢ãƒªã‚„ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã™ã‚‹ã«ã¯ã€ç•ªå·ã‚’ãƒã‚¤ãƒˆåˆ—ã«å¤‰æ›ã™ã‚‹ãƒ«ãƒ¼ãƒ«ãŒå¿…è¦ã€‚
ãã‚ŒãŒ**ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°**ã€‚

### Code Unit ã¨ã¯

ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒå‡¦ç†ã™ã‚‹**æœ€å°ã®ãƒ‡ãƒ¼ã‚¿å˜ä½**ã€‚

ä¾‹ãˆã‚‹ãªã‚‰:
- æ–‡ç« ã‚’ç®±ã«è©°ã‚ã¦é€ã‚‹ã¨ãã€**ç®±ã®ã‚µã‚¤ã‚º**ãŒ Code Unit
- 1ã¤ã®æ–‡å­—(Code Point)ãŒç®±1å€‹ã§æ¸ˆã‚€ã“ã¨ã‚‚ã‚ã‚Œã°ã€2å€‹å¿…è¦ãªã“ã¨ã‚‚ã‚ã‚‹

| ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° | Code Unit ã‚µã‚¤ã‚º | èª¬æ˜                                 |
|:-----------------|:-----------------|:-------------------------------------|
| **UTF-8**        | 1 byte (8bit)    | 1ç®± = 1ãƒã‚¤ãƒˆã€‚æ–‡å­—ã«ã‚ˆã£ã¦1~4ç®±ä½¿ã† |
| **UTF-16**       | 2 bytes (16bit)  | 1ç®± = 2ãƒã‚¤ãƒˆã€‚æ–‡å­—ã«ã‚ˆã£ã¦1~2ç®±ä½¿ã† |
| **UTF-32**       | 4 bytes (32bit)  | 1ç®± = 4ãƒã‚¤ãƒˆã€‚å¸¸ã«1ç®±               |

### UTF-8: å¯å¤‰é•·ã®ä»•çµ„ã¿

UTF-8 ã¯ Code Unit ãŒ 1 byteã€‚1ã¤ã® Code Point ã‚’ 1~4 Code Units (= 1~4 bytes) ã§è¡¨ç¾ã™ã‚‹ã€‚
å…ˆé ­ãƒ“ãƒƒãƒˆã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã€Œã“ã®æ–‡å­—ã¯ä½•ãƒã‚¤ãƒˆã‹ã€ã‚’åˆ¤åˆ¥ã™ã‚‹:

```
1ãƒã‚¤ãƒˆæ–‡å­—:  0xxxxxxx                        (U+0000 ~ U+007F,   ASCII)
2ãƒã‚¤ãƒˆæ–‡å­—:  110xxxxx 10xxxxxx                (U+0080 ~ U+07FF)
3ãƒã‚¤ãƒˆæ–‡å­—:  1110xxxx 10xxxxxx 10xxxxxx       (U+0800 ~ U+FFFF)
4ãƒã‚¤ãƒˆæ–‡å­—:  11110xxx 10xxxxxx 10xxxxxx 10xx  (U+10000 ~ U+10FFFF)
```

ä¾‹: `ã‚` = U+3042 = 0x3042 = 0011 0000 0100 0010
```
3ãƒã‚¤ãƒˆæ–‡å­—ã®å½¢å¼: 1110xxxx 10xxxxxx 10xxxxxx
x ã«è©°ã‚ã‚‹:        1110_0011 10_000001 10_000010
16é€²:               E3       81        82
```
â†’ UTF-8 ã§ã¯ `E3 81 82` ã®3ãƒã‚¤ãƒˆ (= 3 Code Units)

| Code Point | æ–‡å­— | UTF-8 bytes   | Code Unit æ•° |
|:-----------|:-----|:--------------|:-------------|
| U+0041     | A    | `41`          | 1            |
| U+00E9     | Ã©    | `C3 A9`       | 2            |
| U+3042     | ã‚   | `E3 81 82`    | 3            |
| U+1F600    | ğŸ˜€   | `F0 9F 98 80` | 4            |

### UTF-16: ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢ã®ä»•çµ„ã¿

UTF-16 ã¯ Code Unit ãŒ 2 bytes (16bit)ã€‚16bit ã§è¡¨ç¾ã§ãã‚‹ã®ã¯ 0 ~ 65535 (= U+FFFF ã¾ã§)ã€‚

Unicode ã® Code Point ã¯ U+10FFFF ã¾ã§ã‚ã‚‹ã®ã§ã€**U+10000 ä»¥ä¸Šã®æ–‡å­—ã¯ 16bit 1ã¤ã§ã¯è¶³ã‚Šãªã„**ã€‚
ãã“ã§ **2ã¤ã® Code Unit ã‚’çµ„ã¿åˆã‚ã›ã¦1ã¤ã® Code Point ã‚’è¡¨ç¾ã™ã‚‹**ã®ãŒã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢ã€‚

#### BMP (Basic Multilingual Plane)

Unicode ã® Code Point ç©ºé–“ã¯ **Plane (é¢)** ã«åˆ†ã‹ã‚Œã¦ã„ã‚‹:

```
Plane 0:  U+0000  ~ U+FFFF    â† BMP (åŸºæœ¬å¤šè¨€èªé¢)
Plane 1:  U+10000 ~ U+1FFFF   â† SMP (è¿½è£œå¤šè¨€èªé¢, çµµæ–‡å­—ã®å¤šãã¯ã“ã“)
Plane 2:  U+20000 ~ U+2FFFF   â† SIP (è¿½è£œæ¼¢å­—é¢)
  ...
Plane 16: U+100000 ~ U+10FFFF
```

- **BMP å†…** (U+0000 ~ U+FFFF): UTF-16 Code Unit 1ã¤ã§ãã®ã¾ã¾è¡¨ç¾ã§ãã‚‹
- **BMP å¤–** (U+10000 ~): ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢ãŒå¿…è¦

#### ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢ã®è¨ˆç®—

BMP ã®ä¸­ã«ã€Œæ–‡å­—ã‚’å‰²ã‚Šå½“ã¦ãªã„äºˆç´„é ˜åŸŸã€ãŒã‚ã‚‹:

```
U+D800 ~ U+DBFF  â†’  High Surrogate (ä¸Šä½ã‚µãƒ­ã‚²ãƒ¼ãƒˆ)  1024å€‹
U+DC00 ~ U+DFFF  â†’  Low Surrogate  (ä¸‹ä½ã‚µãƒ­ã‚²ãƒ¼ãƒˆ)  1024å€‹
```

ã“ã®2ã¤ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã¨ 1024 x 1024 = 1,048,576 é€šã‚Š = ã¡ã‚‡ã†ã© U+10000 ~ U+10FFFF ã‚’ã‚«ãƒãƒ¼ã§ãã‚‹ã€‚

ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ‰‹é † (ä¾‹: ğŸ˜€ = U+1F600):
```
1. U+10000 ã‚’å¼•ã:  0x1F600 - 0x10000 = 0xF600
2. ä¸Šä½10bit:       0xF600 >> 10    = 0x3D    â†’ 0xD800 + 0x3D = 0xD83D (High Surrogate)
3. ä¸‹ä½10bit:       0xF600 & 0x3FF  = 0x200   â†’ 0xDC00 + 0x200 = 0xDE00 (Low Surrogate)
```
â†’ UTF-16 ã§ã¯ `D83D DE00` ã® 2 Code Units (= 4 bytes)

#### ã‚µãƒ­ã‚²ãƒ¼ãƒˆã®è¦ç‚¹

- ã‚µãƒ­ã‚²ãƒ¼ãƒˆ (U+D800 ~ U+DFFF) ã¯ **æ–‡å­—ã§ã¯ãªã„**ã€‚ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®ä»•çµ„ã¿å°‚ç”¨ã®ç•ªå·
- å˜ç‹¬ã§ç¾ã‚Œã¦ã¯ã„ã‘ãªã„ã€‚å¿…ãš High + Low ã®ãƒšã‚¢ã§ä½¿ã†
- Rust ã® `char` ã¯ Scalar Value = ã‚µãƒ­ã‚²ãƒ¼ãƒˆã‚’é™¤ã„ãŸ Code Pointã€‚ã ã‹ã‚‰ `char` ã«ã‚µãƒ­ã‚²ãƒ¼ãƒˆã®å€¤ã¯å…¥ã‚‰ãªã„

### UTF-16 ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ä¾‹

| Code Point | æ–‡å­— | UTF-16 Code Units | Code Unitæ•° | å‚™è€ƒ                  |
|:-----------|:-----|:------------------|:------------|:----------------------|
| U+0041     | A    | `0041`            | 1           | BMPå†…ã€ãã®ã¾ã¾       |
| U+3042     | ã‚   | `3042`            | 1           | BMPå†…ã€ãã®ã¾ã¾       |
| U+1F600    | ğŸ˜€   | `D83D DE00`       | 2           | BMPå¤–ã€ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢ |
| U+1F1EF    | ğŸ‡¯    | `D83C DDEF`       | 2           | BMPå¤–ã€ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢ |

> **JavaScript ã® `.length` ã¯ UTF-16 Code Unit æ•°ã‚’è¿”ã™ã€‚**
> `"ğŸ˜€".length === 2` ã«ãªã‚‹ã®ã¯ã“ã®ãŸã‚ã€‚
> `"ã‚".length === 1` (BMPå†…ãªã®ã§ Code Unit 1ã¤)

### 3ã¤ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ¯”è¼ƒã¾ã¨ã‚

```
æ–‡å­—: ğŸ˜€ (U+1F600)

UTF-8:  F0 9F 98 80           â†’ 4 Code Units (4 bytes)
UTF-16: D83D DE00             â†’ 2 Code Units (4 bytes)
UTF-32: 0001F600              â†’ 1 Code Unit  (4 bytes)
```

```
æ–‡å­—: A (U+0041)

UTF-8:  41                    â†’ 1 Code Unit  (1 byte)
UTF-16: 0041                  â†’ 1 Code Unit  (2 bytes)
UTF-32: 00000041              â†’ 1 Code Unit  (4 bytes)
```

UTF-8 ã¯ ASCII ã«å¼·ãã€UTF-32 ã¯å›ºå®šé•·ã§å˜ç´”ã€UTF-16 ã¯ãã®ä¸­é–“ã€‚

---

## Grapheme Cluster (æ›¸è¨˜ç´ ã‚¯ãƒ©ã‚¹ã‚¿)

**äººé–“ãŒè¦–è¦šçš„ã«ã€Œ1æ–‡å­—ã€ã¨èªè­˜ã™ã‚‹å˜ä½**ã€‚
UAX #29 (Unicode Text Segmentation) ã§å®šç¾©ã•ã‚Œã‚‹ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ãã€‚

1ã¤ã® Grapheme Cluster ã¯ **1ã¤ä»¥ä¸Šã® Code Point** ã‹ã‚‰æˆã‚‹ã€‚

### ãªãœ Code Point ã ã‘ã§ã¯ä¸ååˆ†ã‹

Unicode ã§ã¯åŒã˜ã€Œè¦‹ãŸç›®ã®æ–‡å­—ã€ã‚’è¤‡æ•°ã®æ–¹æ³•ã§è¡¨ç¾ã§ãã‚‹:

```
Ã© = U+00E9                    (1 code point, åˆæˆæ¸ˆã¿å½¢ NFC)
Ã© = U+0065 U+0301             (2 code points, åˆ†è§£å½¢ NFD)
    â†‘ e    â†‘ combining acute
```

ã©ã¡ã‚‰ã‚‚è¦‹ãŸç›®ã¯åŒã˜ Ã© ã§ã€Grapheme Cluster ã¨ã—ã¦ã¯ 1ã€‚
ã—ã‹ã— Code Point æ•°ã¯ 1 ã¨ 2 ã§ç•°ãªã‚‹ã€‚

### è¤‡æ•° Code Point â†’ 1 Grapheme ã®ä¾‹

| è¦‹ãŸç›® | Code Points                                          | CPæ•° | èª¬æ˜                               |
|:-------|:-----------------------------------------------------|:-----|:-----------------------------------|
| Ã©      | U+0065 U+0301                                        | 2    | åŸºåº•æ–‡å­— + çµåˆæ–‡å­—                |
| ğŸ‡¯ğŸ‡µ     | U+1F1EF U+1F1F5                                      | 2    | Regional Indicator (å›½æ——)          |
| ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦     | U+1F468 U+200D U+1F469 U+200D U+1F467 U+200D U+1F466 | 7    | ZWJ (Zero Width Joiner) ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ |
| 1ï¸âƒ£     | U+0031 U+FE0F U+20E3                                 | 3    | Keycap ã‚·ãƒ¼ã‚±ãƒ³ã‚¹                  |
| ğŸ‘©ğŸ½     | U+1F469 U+1F3FD                                      | 2    | Emoji + Skin Tone Modifier         |

---

## Grapheme Cluster ã®ãƒ«ãƒ¼ãƒ« (ç°¡ç•¥ç‰ˆ)

UAX #29 ã§å®šç¾©ã•ã‚Œã‚‹ä¸»ãªãƒ«ãƒ¼ãƒ«:

1. **CR + LF** â†’ 1 grapheme (æ”¹è¡Œã‚·ãƒ¼ã‚±ãƒ³ã‚¹)
2. **åŸºåº•æ–‡å­— + çµåˆæ–‡å­— (Combining Mark)** â†’ 1 grapheme
3. **ãƒãƒ³ã‚°ãƒ«éŸ³ç¯€ã®çµåˆ** â†’ 1 grapheme (éŸ“å›½èªã® jamo çµåˆ)
4. **Regional Indicator ãƒšã‚¢** â†’ 1 grapheme (å›½æ——)
5. **ZWJ (U+200D) ã§çµåˆã•ã‚ŒãŸçµµæ–‡å­—** â†’ 1 grapheme
6. **Emoji Modifier (è‚Œè‰²)** â†’ å‰ã®çµµæ–‡å­—ã¨çµåˆã—ã¦ 1 grapheme
7. **Variation Selector + Combining Enclosing** â†’ Keycap ç­‰

ä¸Šè¨˜ã«è©²å½“ã—ãªã„ Code Point ã¯å˜ç‹¬ã§ 1 graphemeã€‚

---

## æ­£è¦åŒ– (Normalization)

åŒã˜æ–‡å­—ã«è¤‡æ•°ã®è¡¨ç¾ãŒã‚ã‚‹å•é¡Œã‚’è§£æ±ºã™ã‚‹ä»•çµ„ã¿ã€‚4ã¤ã®æ­£è¦åŒ–å½¢å¼ãŒã‚ã‚‹:

| å½¢å¼     | èª¬æ˜                                                | ä¾‹ (Ã©)               |
|:---------|:----------------------------------------------------|:---------------------|
| **NFC**  | Canonical Decomposition â†’ Canonical Composition     | U+00E9 (åˆæˆ)        |
| **NFD**  | Canonical Decomposition                             | U+0065 U+0301 (åˆ†è§£) |
| **NFKC** | Compatibility Decomposition â†’ Canonical Composition | U+00E9               |
| **NFKD** | Compatibility Decomposition                         | U+0065 U+0301        |

- **NFC**: Web ã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ä¸€èˆ¬çš„ã€‚åˆæˆæ¸ˆã¿ã®å½¢ã«æ­£è¦åŒ–ã€‚
- **NFD**: macOS ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ  (HFS+) ã§ä½¿ã‚ã‚Œã‚‹ã€‚åˆ†è§£å½¢ã€‚

æ–‡å­—åˆ—æ¯”è¼ƒã®ã¨ãã¯æ­£è¦åŒ–ã‚’æƒãˆãªã„ã¨ã€è¦‹ãŸç›®ãŒåŒã˜ã§ã‚‚ä¸ä¸€è‡´ã«ãªã‚Šã†ã‚‹ã€‚

---

## å„è¨€èªã§ã®ã€Œé•·ã•ã€ã®æ„å‘³

| è¨€èª / API                       | ä½•ã‚’æ•°ãˆã‚‹ã‹                | `"ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦"` ã®çµæœ |
|:---------------------------------|:----------------------------|:--------------|
| Rust `s.len()`                   | UTF-8 bytes                 | 25            |
| Rust `s.chars().count()`         | Code Points (Scalar Values) | 7             |
| Rust `s.graphemes(true).count()` | Grapheme Clusters           | 1             |
| JavaScript `s.length`            | UTF-16 Code Units           | 11            |
| Python `len(s)`                  | Code Points                 | 7             |
| Swift `s.count`                  | Grapheme Clusters           | 1             |
| Go `len(s)`                      | UTF-8 bytes                 | 25            |
| Go `utf8.RuneCountInString(s)`   | Code Points (Rune)          | 7             |

---

## ã¾ã¨ã‚: ã‚«ã‚¦ãƒ³ãƒˆå˜ä½ã®åŒ…å«é–¢ä¿‚

```
1 Grapheme Cluster  â‰¥  1 Code Point  â‰¥  1 Code Unit  â‰¥  1 Byte

ä¾‹: ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦
  1 Grapheme Cluster
  = 7 Code Points
  = 11 UTF-16 Code Units (4 ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢ + 3 ZWJ)
  = 25 UTF-8 Bytes
```

ã€Œæ–‡å­—æ•°åˆ¶é™ N æ–‡å­—ã€ã¨è¨€ã‚ã‚ŒãŸã¨ãã€**ä½•ã‚’ N ã§æ•°ãˆã‚‹ã‹**ãŒå•é¡Œã«ãªã‚‹ã€‚
API ã”ã¨ã«ç•°ãªã‚‹ãŸã‚ã€ä»•æ§˜ã®ç¢ºèªãŒå¿…è¦ã€‚

---

## å‚è€ƒ

- [Unicode Standard](https://www.unicode.org/versions/latest/)
- [UAX #29: Unicode Text Segmentation](https://unicode.org/reports/tr29/) - Grapheme Cluster ã®å®šç¾©
- [UAX #15: Unicode Normalization Forms](https://unicode.org/reports/tr15/) - NFC/NFD ç­‰
- [UTF-8 Encoding](https://en.wikipedia.org/wiki/UTF-8)
